#include "PMTSD.hh"
#include "EventAction.hh"
#include "G4AnalysisManager.hh"
#include "G4RunManager.hh"
#include "G4Step.hh"
#include "G4OpticalPhoton.hh"
#include "G4SystemOfUnits.hh"

PMTSD::PMTSD(G4String name) : G4VSensitiveDetector(name) 
{}

PMTSD::~PMTSD() 
{}

void PMTSD::Initialize(G4HCofThisEvent*) 
{}


G4bool PMTSD::ProcessHits(G4Step* aStep, G4TouchableHistory*) {
    if (aStep->GetTrack()->GetDefinition() == G4OpticalPhoton::OpticalPhotonDefinition()) {

        G4String name = GetName();
        auto eventAction = (EventAction*)G4RunManager::GetRunManager()->GetUserEventAction();

	if      (name == "PMT_SD_L0") eventAction->AddPMTHitL_Bot();
	else if (name == "PMT_SD_R0") eventAction->AddPMTHitR_Bot();
	else if (name == "PMT_SD_L1") eventAction->AddPMTHitL_Mid();
        else if (name == "PMT_SD_R1") eventAction->AddPMTHitR_Mid();
	else if (name == "PMT_SD_L2") eventAction->AddPMTHitL_Top();
        else if (name == "PMT_SD_R2") eventAction->AddPMTHitR_Top();
	
        auto am = G4AnalysisManager::Instance();
	
        G4double hitTime = aStep->GetPostStepPoint()->GetGlobalTime();
        G4double energy = aStep->GetTrack()->GetKineticEnergy();
	G4int trackID = aStep->GetTrack()->GetTrackID();
        G4int evtID = G4RunManager::GetRunManager()->GetCurrentEvent()->GetEventID();

	G4int pmtID = -1;

	if (name == "PMT_SD_L0") pmtID = 0; else if (name == "PMT_SD_R0") pmtID = 1;
	else if (name == "PMT_SD_L1") pmtID = 2; else if (name == "PMT_SD_R1") pmtID = 3;
	else if (name == "PMT_SD_L2") pmtID = 4; else if (name == "PMT_SD_R2") pmtID = 5;

        
        // Registra il tempo del primo fotone
        eventAction->RegisterPMTHit(hitTime);

        // Salva l'energia del fotone nella Tabella 1
       
        am->FillNtupleIColumn(1, 0, evtID);
	am->FillNtupleIColumn(1, 1, trackID);
        am->FillNtupleDColumn(1, 3, energy/eV);
	am->FillNtupleDColumn(1, 4, hitTime/ns);
	am->FillNtupleIColumn(1, 5, pmtID);
        am->AddNtupleRow(1);

        aStep->GetTrack()->SetTrackStatus(fStopAndKill);
        return true;
    }
    return false;
}

void PMTSD::EndOfEvent(G4HCofThisEvent*) 
{}
